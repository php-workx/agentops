name: Installer Validation

on:
  pull_request:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'profiles/**'
      - 'core/**'
      - '.github/workflows/installer-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'profiles/**'
      - 'core/**'
  workflow_dispatch:

jobs:
  syntax-validation:
    name: Shell Script Syntax Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate bash syntax
        run: |
          echo "üîç Validating shell script syntax..."

          # Validate all shell scripts
          find scripts -name "*.sh" -type f | while read script; do
            echo "Checking: $script"
            bash -n "$script" || exit 1
          done

          echo "‚úÖ All shell scripts have valid syntax"

  profile-validation:
    name: Profile Manifest Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate profile manifests
        run: |
          echo "üîç Validating profile manifests..."

          EXIT_CODE=0

          for manifest in profiles/*/profile.yaml; do
            echo ""
            echo "Validating: $manifest"

            # Check YAML syntax
            if ! yq eval '.' "$manifest" > /dev/null 2>&1; then
              echo "‚ùå Invalid YAML syntax: $manifest"
              EXIT_CODE=1
              continue
            fi

            # Validate required fields
            PROFILE_NAME=$(basename $(dirname "$manifest"))

            # Check apiVersion
            if ! yq eval '.apiVersion' "$manifest" | grep -q "agentops.io/v1"; then
              echo "‚ùå Missing or invalid apiVersion in $manifest"
              EXIT_CODE=1
            fi

            # Check kind
            if ! yq eval '.kind' "$manifest" | grep -q "Profile"; then
              echo "‚ùå Missing or invalid kind in $manifest"
              EXIT_CODE=1
            fi

            # Check metadata.name
            NAME=$(yq eval '.metadata.name' "$manifest")
            if [ "$NAME" != "$PROFILE_NAME" ]; then
              echo "‚ùå Profile name mismatch: directory=$PROFILE_NAME, manifest=$NAME"
              EXIT_CODE=1
            fi

            # Check agent_count exists
            if ! yq eval '.spec.agent_count' "$manifest" | grep -qE '^[0-9]+$'; then
              echo "‚ùå Missing or invalid agent_count in $manifest"
              EXIT_CODE=1
            fi

            echo "‚úÖ $manifest validated"
          done

          if [ $EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ All profile manifests validated successfully"
          else
            echo ""
            echo "‚ùå Profile validation failed"
          fi

          exit $EXIT_CODE

  installer-dry-run:
    name: Installer Dry Run Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        profile: [product-dev, infrastructure-ops, devops, life]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test installer help
        run: |
          echo "üîç Testing installer help..."
          chmod +x scripts/install.sh
          scripts/install.sh --help
          echo "‚úÖ Installer help works"

      - name: Test installer validation-only mode
        run: |
          echo "üîç Testing installer validation mode..."
          # This tests the installer logic without actually installing
          scripts/install.sh --validate-only || echo "Expected: No installation to validate"
          echo "‚úÖ Validation-only mode works"

      - name: Verify profile exists
        run: |
          echo "üîç Verifying profile ${{ matrix.profile }} exists..."

          if [ ! -d "profiles/${{ matrix.profile }}" ]; then
            echo "‚ùå Profile directory not found: profiles/${{ matrix.profile }}"
            exit 1
          fi

          if [ ! -f "profiles/${{ matrix.profile }}/profile.yaml" ]; then
            echo "‚ùå Profile manifest not found: profiles/${{ matrix.profile }}/profile.yaml"
            exit 1
          fi

          echo "‚úÖ Profile ${{ matrix.profile }} exists"

  library-validation:
    name: Library Functions Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test library functions
        run: |
          echo "üîç Testing library functions..."

          # Source libraries
          source scripts/lib/common-functions.sh
          source scripts/lib/validation.sh
          source scripts/lib/logging.sh

          # Test common functions exist
          declare -f print_color > /dev/null || { echo "‚ùå print_color not found"; exit 1; }
          declare -f die > /dev/null || { echo "‚ùå die not found"; exit 1; }
          declare -f success > /dev/null || { echo "‚ùå success not found"; exit 1; }
          declare -f warn > /dev/null || { echo "‚ùå warn not found"; exit 1; }
          declare -f info > /dev/null || { echo "‚ùå info not found"; exit 1; }
          declare -f get_active_profile > /dev/null || { echo "‚ùå get_active_profile not found"; exit 1; }

          # Test validation functions exist
          declare -f validate_core_installation > /dev/null || { echo "‚ùå validate_core_installation not found"; exit 1; }
          declare -f validate_profile > /dev/null || { echo "‚ùå validate_profile not found"; exit 1; }
          declare -f validate_12factor_compliance > /dev/null || { echo "‚ùå validate_12factor_compliance not found"; exit 1; }

          # Test logging functions exist
          declare -f log_json > /dev/null || { echo "‚ùå log_json not found"; exit 1; }
          declare -f log_info > /dev/null || { echo "‚ùå log_info not found"; exit 1; }
          declare -f log_error > /dev/null || { echo "‚ùå log_error not found"; exit 1; }

          echo "‚úÖ All library functions present"

  command-validation:
    name: Command Files Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate base commands
        run: |
          echo "üîç Validating base commands..."

          # Check core commands exist
          if [ ! -d "core/commands" ]; then
            echo "‚ùå core/commands directory not found"
            exit 1
          fi

          # Validate markdown syntax (basic check)
          for cmd in core/commands/*.md; do
            if [ -f "$cmd" ]; then
              echo "Checking: $cmd"
              # Check for YAML frontmatter
              if ! head -1 "$cmd" | grep -q "^---"; then
                echo "‚ö†Ô∏è  Warning: $cmd missing YAML frontmatter"
              fi
              # Check file not empty
              if [ ! -s "$cmd" ]; then
                echo "‚ùå Empty file: $cmd"
                exit 1
              fi
            fi
          done

          echo "‚úÖ Base commands validated"

      - name: Validate profile command overrides
        run: |
          echo "üîç Validating profile command overrides..."

          for profile_cmds in profiles/*/commands/*.md; do
            if [ -f "$profile_cmds" ]; then
              echo "Checking: $profile_cmds"
              # Check file not empty
              if [ ! -s "$profile_cmds" ]; then
                echo "‚ùå Empty file: $profile_cmds"
                exit 1
              fi
            fi
          done

          echo "‚úÖ Profile command overrides validated"

  documentation-validation:
    name: Documentation Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required documentation
        run: |
          echo "üîç Checking required documentation..."

          REQUIRED_DOCS=(
            "INSTALL.md"
            "CHANGELOG.md"
            "README.md"
          )

          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "‚ùå Missing required documentation: $doc"
              exit 1
            fi
            echo "‚úÖ Found: $doc"
          done

          echo "‚úÖ All required documentation present"

      - name: Validate CHANGELOG format
        run: |
          echo "üîç Validating CHANGELOG.md format..."

          # Check for version headings
          if ! grep -q "## \[1.0.0\]" CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md missing v1.0.0 entry"
            exit 1
          fi

          echo "‚úÖ CHANGELOG.md format valid"

  integration-test:
    name: Integration Test (Mock Installation)
    runs-on: ubuntu-latest
    needs: [syntax-validation, profile-validation, library-validation]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Mock installation test
        run: |
          echo "üîç Running mock installation test..."

          # Make scripts executable
          chmod +x scripts/*.sh
          chmod +x scripts/lib/*.sh

          # Test help works
          echo "Testing installer help..."
          scripts/install.sh --help

          # Test project installer help
          echo "Testing project installer help..."
          scripts/project-install.sh --help

          # Test validation script help
          echo "Testing validation script help..."
          scripts/validate-installation.sh --help

          echo "‚úÖ Mock installation test passed"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [syntax-validation, profile-validation, installer-dry-run, library-validation, command-validation, documentation-validation, integration-test]
    if: always()

    steps:
      - name: Check validation results
        run: |
          echo "üìä Installer Validation Summary"
          echo "=============================="
          echo ""
          echo "‚úÖ Syntax Validation: ${{ needs.syntax-validation.result }}"
          echo "‚úÖ Profile Validation: ${{ needs.profile-validation.result }}"
          echo "‚úÖ Installer Dry Run: ${{ needs.installer-dry-run.result }}"
          echo "‚úÖ Library Validation: ${{ needs.library-validation.result }}"
          echo "‚úÖ Command Validation: ${{ needs.command-validation.result }}"
          echo "‚úÖ Documentation Validation: ${{ needs.documentation-validation.result }}"
          echo "‚úÖ Integration Test: ${{ needs.integration-test.result }}"
          echo ""

          # Check if any job failed
          if [ "${{ needs.syntax-validation.result }}" != "success" ] || \
             [ "${{ needs.profile-validation.result }}" != "success" ] || \
             [ "${{ needs.installer-dry-run.result }}" != "success" ] || \
             [ "${{ needs.library-validation.result }}" != "success" ] || \
             [ "${{ needs.command-validation.result }}" != "success" ] || \
             [ "${{ needs.documentation-validation.result }}" != "success" ] || \
             [ "${{ needs.integration-test.result }}" != "success" ]; then
            echo "‚ùå Some validation checks failed"
            exit 1
          fi

          echo "‚úÖ All validation checks passed!"
          echo ""
          echo "üöÄ Ready to merge to main (v1.0.0)"
